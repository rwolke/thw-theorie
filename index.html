<!doctype html>
<html lang="de" manifest="app.manifest">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<link rel="icon" href="images/logo.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="images/logo.png" />
	<link rel="apple-touch-icon-precomposed" href="images/logo.png" />
	
	<title>THW Theorie</title>
	<link rel="stylesheet" href="css/thw-1.3.1.min.css" />
	<link rel="stylesheet" href="css/jquery.mobile.structure-1.3.1.min.css" />
	<script src="js/jquery-1.9.1.min.js"></script>
	<script src="js/jquery.color-2.1.1.min.js"></script>
	<script>
		$(document).bind( "mobileinit", function(){
			$.mobile.page.prototype.options.theme = 'a';
			$.mobile.buttonMarkup.hoverDelay = 50;
		});
	</script>
	<script src="js/jquery.mobile-1.3.1.min.js"></script>
	<script>
		var runningOnPhonegap = false;
		window.addEventListener('online', function(){});
		window.addEventListener('offline', function(){});
		try{
			window.applicationCache.addEventListener('updateready', function(){
				$('#popup-update').popup();
				$('#popup-update').popup("open");
			}, false);
		}catch(e){}
		$(document).ajaxError(function(event, request, settings, error ) {
			alert('Benötigte Datei "' + settings.url + '" konnte nicht geladen werden!\n' + errror);
		});
		
		function THWTheorie() {
			/*
			 *  properties
			 */
			this.features = {
				json : false,
				localStorage : false,
				applicationCache : false
			};
			this.questionSets = {
				"2006" : {name: "Stand 2006", file:"questions_2006v1.json"},
				"2013" : {name: "Stand 2013", file:"questions_2013v1.json"},
				"2014" : {name: "Stand 2014 v2.0", file:"questions_2014v1.json"}
			}
			this.defaultSettings = {
				selectedQuestionSet: "2014",
				randomizeQuestions : false
			};
			this.loadedFromStorage = [];
			this.questions = null;
			this.flashcard;
			this.settings;
			
			/*
			 *  methods
			 */
			this.initStorage = function(name, fallback, doNotLoad) {
				var obj = fallback;
				// do testing
				if(localStorage['THWTheorie_' + name] && (doNotLoad == null || !doNotLoad))
					obj = JSON.parse(localStorage['THWTheorie_' + name]);
				
				if(this.features.localStorage)
				{
					obj.save = function() {
						localStorage['THWTheorie_' + name] = JSON.stringify(this);
					};
					this.loadedFromStorage.push('THWTheorie_' + name);
				}
				else
					obj.save = function() {};
				return obj;
			};
			this.resetStorage = function() {
				for(var i = 0; i < this.loadedFromStorage.length; i++)
					if(localStorage[this.loadedFromStorage[i]])
						delete localStorage[this.loadedFromStorage[i]];
				this.statistic = new THWTheorie_Statistic(this, true);
				this.flashcard = new THWTheorie_Flashcard(this, true);
			}
			this.loadQuestionCatalog = function(upgrade) {
				// load questions
				var that = this;
				$.ajax({
					async: false,
					url: this.questionSets[this.settings.selectedQuestionSet].file,
					dataType: "json",
					success: function(data) {
						that.questions = data;
						for(var qid in that.questions.questions)
							if(!that.questions.category[that.questions.questions[qid].category].list)
								that.questions.category[that.questions.questions[qid].category].list = [qid];
							else
								that.questions.category[that.questions.questions[qid].category].list.push(qid);
					},
					error: function() {
						throw new Error('Fragenkatalog konnte nicht geladen werden!');
					}
				});
				
				if(upgrade) {
					this.statistic = new THWTheorie_Statistic(this, true);
					this.flashcard = new THWTheorie_Flashcard(this, true);
				}
			}
			
			/*
			 *  constructor
			 */
			// determine features of browser
			try { this.features.json = typeof JSON == "object" && JSON && typeof JSON.parse == "function" && typeof JSON.stringify == "function"; } catch (e) {}
			try { this.features.localStorage = 'localStorage' in window && window['localStorage'] !== null; } catch (e) {}
			try { this.features.applicationCache = 'applicationCache' in window && window['applicationCache'] !== null; } catch (e) {}
			
			// JSON fallback
			if(!this.features.json && this.features.localStorage)
				$.ajax({
					url: "js/json2.min.js",
					async: false,
					dataType: "script"
				});
			
			// load settings
			this.settings = this.initStorage('settings', this.defaultSettings);
			this.loadQuestionCatalog();
			
			this.statistic = new THWTheorie_Statistic(this, false);
			this.flashcard = new THWTheorie_Flashcard(this, false);
		}
		
		function THWTheorie_Statistic(owner, reset) {
			/*
			 *  properties
			 */
			this.owner = owner;
			this.data = {
				startTime : (new Date()).getTime(),
				training : { total: 0, correct : 0 },
				exam : { total: 0, correct : 0 }
			};
			
			/*
			 *  methods
			 */
			this.setTrainingResult = function(correct) {
				this.data.training.total++;
				if(correct)
					this.data.training.correct++;
				this.data.save();
			};
			this.setExamResult = function(correct) {
				this.data.exam.total++;
				if(correct)
					this.data.exam.correct++;
				this.data.save();
			};
			this.getStatistic = function() {
				return this.data;
			}
			
			/*
			 *  constructor
			 */
			this.data = this.owner.initStorage('statistic', this.data, reset);
		}
		
		function THWTheorie_Flashcard(owner, reset) {
			this.owner = owner;
			
			/*
			 *  properties
			 */
			// learn progress
			this.progress = {
				// entries in first box
				box : [],
				// entries in second box
				other : [],
				// confidence (how well the answer is known)
				confidence : [] // questionIndex => confidenceValue
			};
			
			// settings for noting progress
			this.settings = {
				// size of first learn box, i.e. repeat interval for wrong
				//	answers
				boxSize : 20,
				// how to calculate learn leven of question, used as
				//	new_confidence = expireFactor * old_confidence 
				//	 + (1 - expireFactor) * (answeredCorrect ? 1 : 0);
				expireFactor : 0.5
			};
			
			/*
			 *  methods
			 */
			this.setBoxSize = function(newSize){
				if(newSize < 10 || newSize > 50)
					return "Größe für Box muss zwischen 10 und 50 liegen";

				this.settings.boxSize = newSize;
				this.settings.save();

				this.setMultipleQuestionResult();
			};
			this.setExpireFactor = function(factor){
				if(factor < 0.1 || factor > 0.7)
					return "Größe für den Faktor muss zwischen 0.1 und 0.7 liegen";

				this.settings.expireFactor = factor;
				this.settings.save();
			};
			this.getFirstQuestion = function() {
				return this.progress.box[0];
			}
			this.setFirstQuestionResult = function(correct) {
				// we got the result for the first question in the box
				var q = this.progress.box[0];
				var o = {};
				o[q] = correct;
				this.setMultipleQuestionResult(o);
			}
			this.setMultipleQuestionResult = function(q2result) {
				if(q2result == null)
					q2result = {};
				
				// update confidence
				for(var q in q2result)
				{
					this.progress.confidence[q] = 
						this.settings.expireFactor * this.progress.confidence[q]
						+ (1 - this.settings.expireFactor) * (q2result[q] ? 1 : 0);
					
					this.owner.statistic.setTrainingResult(q2result[q]);
					
					// every ten questions: reduce global confidence to 99%
					if(this.owner.statistic.data.training.total % 10 == 0)
						for(var i in this.progress.confidence)
							this.progress.confidence[i] *= 0.99
				}
				
				var boxCorrect = [];
				var boxIncorrect = [];
				// get all questions of box that were answered 
				for(var q in q2result)
					if(this.progress.box.indexOf(parseInt(q)) != -1)
					{
						if(q2result[q])
							boxCorrect.push(parseInt(q));
						else
							boxIncorrect.push(parseInt(q));
						this.progress.box.splice(this.progress.box.indexOf(parseInt(q)), 1);
					}
				
				// empty box even more if necessary (needed in case of size change of box)
				while(this.progress.box.length > this.settings.boxSize)
					boxIncorrect.push(this.progress.box.pop());
				
				// fill box with incorrect
				while(this.progress.box.length < this.settings.boxSize && boxIncorrect.length)
					this.progress.box.push(boxIncorrect.shift());
				
				// get all left => put in other
				var leftOver = boxIncorrect.concat(boxCorrect);
				while(leftOver.length) 
					this.progress.other.push(leftOver.shift());
				
				// order
				this.progress.other.sort(function(a,b){ 
					return app.flashcard.progress.confidence[a] - app.flashcard.progress.confidence[b]; 
				});
				
				// fill rest of box
				while(this.progress.box.length < this.settings.boxSize)
					this.progress.box.push(this.progress.other.shift());
				
				this.progress.save();
			}
			
			/*
			 *  constructor
			 */
			this.settings = this.owner.initStorage('flashcard_settings', this.settings);
			this.progress = this.owner.initStorage('flashcard_progress', this.progress, reset);
			if(!this.progress.box.length)
			{
				var q = [];
				var qs = this.owner.questions.questions;
				// fill q in random order
				for(var i = 0; i < qs.length; i++)
					q.splice(Math.floor(Math.random() * (q.length+1)), 0, i);
				
				// fill box and other & set no initial confidence
				for(var i = 0; i < this.settings.boxSize; i++)
					this.progress.box.push(q.shift());
				while(q.length)
					this.progress.other.push(q.shift());
				for(var i = 0; i < qs.length; i++)
					this.progress.confidence.push(0);
				this.progress.save();
			}
		}
		function THWTheorie_PDF(config) {
			this.layout = {
				border : {top : 20, bottom : 20 },
				font : {fontSize: 12, fontStyle: 'normal', fontName: 'times'},
				fontHeight : false,
				lineSepFactor : 0.15,
				paragraphSepFactor : 0.5,
				textOffsetFactor : .775,
				pagesPos : { x: 185, y: 284, text: "[[PAGE]] / [[PAGES]]", font : {} },
				header : {
					height : 8,
					lines : [
						{ x1 :  20, y1 : 0.5, x2: 195, y2 : 0.5, thickness: 8, color: [230,230,230] },
						{ x1 :  20, y1 : 0, x2: 195, y2 : 0, thickness: 0.4 },
						{ x1 :  20, y1 : 1, x2: 195, y2 : 1, thickness: 0.4 },
						{ x1 :  20, y1 : 0, x2:  20, y2 : 1, thickness: 0.4 },
						{ x1 : 195, y1 : 0, x2: 195, y2 : 1, thickness: 0.4 },
						{ x1 :  35, y1 : 0, x2:  35, y2 : 1, thickness: 0.1 },
						{ x1 : 105, y1 : 0, x2: 105, y2 : 1, thickness: 0.1 }
					],
					text : [
						{ x:  22.5, y : 0, text : 'Nr.', font: {fontStyle: 'bold'}  },
						{ x:  37.5, y : 0, text : 'Frage', font: {fontStyle: 'bold'}  },
						{ x: 107.5, y : 0, text : 'Antwortmöglichkeit(en) / Lösung', font: {fontStyle: 'bold'} }
					] 
				},
				columns : {
					nr : { x : 22.5 },
					question : { x : 37.5, width: 65 },
					answers : { x : 107.5, width: 65 },
					abc : { x : 178.5 },
					solution : { x : 188.5, font: {fontStyle: 'bold'} }
				},
				lines : {
					box : [
						{ x1 :  20, y1 : 1, x2: 195, y2 : 1, thickness: 0.4 },
						{ x1 :  20, y1 : 0, x2:  20, y2 : 1, thickness: 0.4 },
						{ x1 :  35, y1 : 0, x2:  35, y2 : 1, thickness: 0.1 },
						{ x1 : 105, y1 : 0, x2: 105, y2 : 1, thickness: 0.1 },
						{ x1 : 175, y1 : 0, x2: 175, y2 : 1, thickness: 0.1 },
						{ x1 : 185, y1 : 0, x2: 185, y2 : 1, thickness: 0.1 },
						{ x1 : 195, y1 : 0, x2: 195, y2 : 1, thickness: 0.4 }
					],
					answers : [
						{ x1 : 105, y1 : 0, x2: 195, y2 : 0, thickness: 0.1 }
					]
				}
			};
			this.getRandomSelection = function(number, categories) {
				if(!categories) {
					categories = [];
					for(var c in app.questions.category)
						categories.push(c);
				}
				
				var q4cat = [];
				var questions = [];
				// check if we got enough questions
				for(var c in categories)
					if(app.questions.category[categories[c]].list)
						q4cat.push({
							c: categories[c],
							n: app.questions.category[categories[c]].list.length
						});
				var sum = q4cat.reduce(function(p, c) { return p + c.n; }, 0);
				
				if(sum < number) {
					number = sum;
					
					for(var i in q4cat)
						questions = questions.concat(app.questions.category[q4cat[i].c].list);
				}
				else {
					// adjust question number of each cat  
					for(var i in q4cat)
						q4cat[i].n *= number / sum;
					
					while(questions.length < number) {
						q4cat.sort(function(a,b){ return b.n - a.n; });
						var q;
						do
						{
							var num = app.questions.category[q4cat[0].c].list.length;
							var pick = Math.floor( Math.random() * ( num + 1 ) );
							q = app.questions.category[q4cat[0].c].list[pick];
						}
						while(isNaN(q) || questions.indexOf(q) != -1);
						questions.push(q);
						q4cat[0].n -= 1;
					}
				}
				
				return this.shuffle(questions);
			}
			this.lastFont = {fontSize: 0, fontStyle: false, fontName: false};
			this.text = function(x,y,text,font) {
				var f = $.extend({}, this.layout.font, font);
				
				if(f.fontName != this.lastFont.fontName)
					this.pdf.setFont(f.fontName);
				if(f.fontStyle != this.lastFont.fontStyle)
					this.pdf.setFontType(f.fontStyle);
				if(f.fontSize != this.lastFont.fontSize)
					this.pdf.setFontSize(f.fontSize);
				
				for(var i in f)
					this.lastFont[i] = f[i];
				
				return this.pdf.text(x,y,text);
			}
			this._layoutQuestion = function(qid, solution) {
				var q = app.questions.questions[qid];
				var tq = this.pdf.splitTextToSize(q.question, this.layout.columns.question.width);
				var ta = [];
				for(var i in q.answers)
					if(q.pdfAnswers)
						ta.push(this.pdf.splitTextToSize(q.pdfAnswers[i], this.layout.columns.answers.width));
					else
						ta.push(this.pdf.splitTextToSize(q.answers[i], this.layout.columns.answers.width));
					
				var hL = this.layout.fontHeight;
				var sL = this.layout.fontHeight * this.layout.lineSepFactor;
				var sP = this.layout.fontHeight * this.layout.paragraphSepFactor;
				
				var taLNum = ta.reduce(function(p, c) { return p + c.length; }, 0);
				var heightQuestion = tq.length * (hL + sL) - sL; // e.g. 3 lines, 2 line separations
				var heightAnswers = taLNum * (hL + sL) - sL + (ta.length - 1) * (sP - sL);
				var height = sP + (heightQuestion > heightAnswers ? heightQuestion : heightAnswers);
				var lines = [];
				for(var i in this.layout.lines.box)
					lines.push($.extend({},this.layout.lines.box[i],{
						y1 : this.layout.lines.box[i].y1 * height, 
						y2 : this.layout.lines.box[i].y2 * height 
					}));
				var textOffset = hL * this.layout.textOffsetFactor;
				
				// calc in font height units
				var text = [
					$.extend({
						y : textOffset + (height - hL) / 2, 
						text: q.category + '.' + q.number
					}, this.layout.columns.nr),
					$.extend({
						y : textOffset + (height - tq.length * (hL+sL) + sL) / 2,
						text : tq
					}, this.layout.columns.question)
				];
				
				var y = sP / 2;
				var s = sP;
				if(heightAnswers < heightQuestion) {
					s += (heightQuestion - heightAnswers) / ta.length;
					y = s / 2;
				}
				var n = 0;
				var abc = ['A','B','C'];
				for(var i in q.answers) {
					text.push($.extend({
						y : textOffset + y,
						text : ta[n]
					}, this.layout.columns.answers));
					text.push($.extend({
						y : textOffset + y + ((ta[n].length - 1) * (hL + sL) + sL) / 2, 
						text : abc[n],
					}, this.layout.columns.abc));
					
					if($.inArray(parseInt(i), q.correct) != -1 && solution)
						text.push($.extend({
							y : textOffset + y + ((ta[n].length - 1) * (hL + sL) + sL) / 2, 
							text : 'X'
						}, this.layout.columns.solution));
					for(var j in this.layout.lines.answers)
						lines.push($.extend({}, this.layout.lines.answers[j],{
							y1 : y + (ta[n].length * (hL + sL) - sL) + s / 2,
							y2 : y + (ta[n].length * (hL + sL) - sL) + s / 2
						}));
					y += (ta[n].length * (hL + sL) - sL) + s;
					n++;
				}
				lines.pop();
				
				return { height: height, text: text, lines: lines };
			}
			this.printQuestionSheet = function(qList, answers) {
				this.pdf = new jsPDF('p', 'mm', 'a4');
				this.lastFont = {fontSize: 0, fontStyle: false, fontName: false};
				
				var page = 0;
				var yStart;
				for(var i in qList) {
					var l = this._layoutQuestion(qList[i], answers);
					if(yStart + l.height > 297 - this.layout.border.bottom || page == 0) {
						if(page++) 
							this.pdf.addPage();
						if(this.layout.pagesPos)
							this.text(
								this.layout.pagesPos.x,
								this.layout.pagesPos.y,
								this.layout.pagesPos.text.replace(/\[\[PAGE\]\]/g, page),
								typeof(this.layout.pagesPos.font) !== 'undefined' ? this.layout.pagesPos.font : {}
							);
						yStart = this.layout.border.top;
						for(var i in this.layout.header.lines) {
							if(typeof(this.layout.header.lines[i].color) === 'undefined')
								this.pdf.setDrawColor(0,0,0);
							else
								this.pdf.setDrawColor(
									this.layout.header.lines[i].color[0], this.layout.header.lines[i].color[0], this.layout.header.lines[i].color[2]
								);
							
							this.pdf.setLineWidth(this.layout.header.lines[i].thickness);
							this.pdf.line(
								this.layout.header.lines[i].x1, this.layout.header.lines[i].y1 * this.layout.header.height + yStart, 
								this.layout.header.lines[i].x2, this.layout.header.lines[i].y2 * this.layout.header.height + yStart
							);
						}
						for(var t in this.layout.header.text)
							this.text(
								this.layout.header.text[t].x,
								this.layout.header.text[t].y + yStart + (this.layout.paragraphSepFactor + this.layout.textOffsetFactor) * this.layout.fontHeight,
								this.layout.header.text[t].text,
								typeof(this.layout.header.text[t].font) !== 'undefined' ? this.layout.header.text[t].font : {}
							);
						yStart += this.layout.header.height;
					}
					
					for(var t in l.text) {
						this.text(
							l.text[t].x,
							l.text[t].y + yStart,
							l.text[t].text,
							typeof(l.text[t].font) !== 'undefined' ? l.text[t].font : {}
						);
						
					}
					for(var i in l.lines) {
						this.pdf.setLineWidth(l.lines[i].thickness);
						this.pdf.line(
							l.lines[i].x1, l.lines[i].y1 + yStart, 
							l.lines[i].x2, l.lines[i].y2 + yStart
						);
					}
					yStart += l.height;
				}
				if(this.layout.pagesPos)
					this.pdf.putTotalPages('\\[\\[PAGES\\]\\]');
				
				return this.pdf;
			}
			this.shuffle = function(o){
				//+ Jonas Raoni Soares Silva
				//@ http://jsfromhell.com/array/shuffle [v1.0]
				for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
				return o;
			};
			
			
			this.layout = $.extend(config, this.layout);
			this.layout.fontHeight = this.layout.font.fontSize / (72 / 25.4);
		}
		
		function THWTheorie_UIHelper(app) {
			this.app = app;
			this.queue = {
				queue : [],
				add : function(callback) {
					this.queue.push(callback);
				},
				run : function(exec) {
					if(exec)
						this.queue.shift()();
					if(this.queue.length)
						setTimeout(function(){ui.queue.run(true);}, 10);
				}
			};
			this.displayQuestion = function(type, context, qid, option) {
				var q = this.app.questions.questions[qid];
				
				html = '<h4 class="text">';
				if(option.prefixTitle)
					html += option.prefixTitle;
				html += q.question;
				if(option.setPostfix)
					html += '<span class="onreveal"> (Frage ' + q.category + '.' + q.number + ')</span>';
				html += '</h4>';

				html += '<div data-role="fieldcontain">';
				html += '<fieldset class="answers" data-qid="' + qid + '" data-role="controlgroup">';
				
				var answerOrder = [];
				for(var no in q.answers)
					if(!app.settings.randomizeQuestions || option.skipRandomize)
						answerOrder.push(parseInt(no));
					else
						answerOrder.splice(Math.floor(Math.random() * (answerOrder.length+1)), 0, parseInt(no));
				
				for(var i = 0; i < answerOrder.length; i++)
				{
					var no = answerOrder[i];
					
					var correct = q.correct.indexOf(no) != -1;
					var id = type + '_' + q.category + '_' + q.number + '_' + no;
					html += '<input type="checkbox" id="' + id + '" ';
					html += 'class="custom ' + (correct ? 'correct' : 'incorrect') + '" ';
					if(option.setChecked && correct)
						html += 'checked="checked" ';
					html += '/>';
					html += '<label for="' + id + '" class="' + (correct ? 'correct' : 'incorrect');
					html += '">'+q.answers[no]+'</label>';
				}
				html += '</fieldset>';
				html += '</div>';
				
				if(!context)
					return html;
				
				context.removeClass('reveal').addClass('ask');
				if(option.setTitle)
					$('.title', context).text('Frage ' + q.category + '.' + q.number);
				
				$('.question', context).html(html).trigger('create');
//				$('.answers input[type=checkbox]', context).checkboxradio();
//				$('fieldset', context).controlgroup();
			}
			
			this.learn = {
				page : '#page-ask',
				start : function() {
					page = '#' + $.mobile.activePage.attr('id');
					$(window).off('keydown').on('keydown', ui.learn.keyboard);
					ui.learn.show();
				},
				show : function() {
					var q = app.flashcard.getFirstQuestion();
					ui.displayQuestion('ask', $(page), q, {
						setTitle:true
					});
				},
				check : function() {
					$('#page-ask').removeClass('ask').addClass('reveal');
					var correct = 1;
					$('#page-ask .answers input').each(function(){
						correct &= $(this).is(':checked') == $(this).hasClass('correct');
					});
					
					$('#page-ask .question, #q-continue')
						.removeClass('correct incorrect')
						.addClass(correct ? 'correct' : 'incorrect');
					
					$('#q-continue .ui-btn-text').text(correct
						? "Richtig! - Weiter zur nächsten Frage..."
						: "Falsch! - Weiter zur nächsten Frage..."
					);
					
					app.flashcard.setFirstQuestionResult(correct);
				},
				reveal : function() {
					$('#page-show').removeClass('ask').addClass('reveal');
				},
				markResult : function(event) {
					var e = $(event.target).prop("tagName").toLowerCase() == 'a' ? $(event.target) : $(event.target).parents('a');
					var id = e.attr('id');
					var correct = id == 'q-known';
					
					app.flashcard.setFirstQuestionResult(correct);
					ui.learn.show();
					return false;
				},
				keyboard : function(event) {
					if($.inArray(event.which, [49,50,51,65,66,67]) != -1)
					{
						var k = event.which % 16 - 1;
						if($(page + ' .answers input').length > k)
							$(page + ' .answers input').eq(k).prop("checked", 
								!$(page + ' .answers input').eq(k).is(':checked')
							).checkboxradio("refresh");
					}
					else if($.inArray(event.which, [32,13,39]) != -1 && page == '#page-ask')
						$($(page).hasClass('reveal') ? '#q-continue' : '#q-check').trigger('click');
					else if($.inArray(event.which, [32,13,39]) != -1 && page == '#page-show' && $(page).hasClass('ask'))
						$('#q-reveal').trigger('click');
					else if(event.which == 37 && page == '#page-show' && $(page).hasClass('reveal')) // left arrow
						$('#q-not-known').trigger('click');
					else if(event.which == 39 && page == '#page-show' && $(page).hasClass('reveal')) // right arrow
						$('#q-known').trigger('click');
				}
			};
			this.questions = {
				active : null,
				printQuestionList : function(event,prev) {
					ui.questions.active = null;
					$(window).off('keydown').on('keydown', ui.questions.keyboard);
					$('#page-questions').toggleClass('setFocus', 
						prev.prevPage.attr('id') == 'page-main'
					);
					var cat = '';
					for(var cid in app.questions.category)
					{
						var c = app.questions.category[cid];
						cat += '<li data-role="list-divider">' + cid + '. ' + c.name;
						cat += ' <span class="ui-li-count">' +c.list.length + '</span>';
						cat += '</li>';

						for(var qid in c.list)
						{
							var q = app.questions.questions[c.list[qid]];
							cat += '<li data-filtertext="';
							cat += q.category + '.' + q.number + ' ';
							cat += q.question;
							for(var i in q.answers)
								cat += ' ' + q.answers[i];
							cat += '"><a href="#popup-answer" data-rel="popup" data-q="' + c.list[qid] + '">';
							cat += '<b>' + q.category + '.' + q.number + '</b> ';
							cat += q.question + '</a></li>';
						}
					}
					$('#page-questions ul').html(cat);
					$('#page-questions ul').listview().listview('refresh');
					$('#page-questions li a').on('click', function(){
						ui.displayQuestion(
							'answer', 
							$('#popup-answer'), 
							$(this).attr('data-q'), 
							{setTitle:true,setChecked:true,skipRandomize:true}
						);
						return true;
					});
				},
				afterDisplay : function() {
					if($('#page-questions').hasClass('setFocus'))
						$('#page-questions .ui-input-search input').focus();
				},
				getLastOrFirst : function(getTop) {
					var lastTop = $('#page-questions li[data-filtertext]:visible').last().position().top < 
						$('#page-questions li[data-filtertext]:visible').first().position().top;
					if(lastTop == getTop)
						return $('#page-questions li[data-filtertext]:visible').last();
					return $('#page-questions li[data-filtertext]:visible').first();
				} ,
				findTopDisplayedQuestion : function() {
					var e = ui.questions.getLastOrFirst(false);
					$('#page-questions li[data-filtertext]:visible').each(function() {
						if(
							$(this).position().top > $(window).scrollTop() &&
							(e.position().top > $(this).position().top)
						)
							e = $(this);
					});
					return e;
				},
				keyboard : function(event) {
					if(ui.questions.active && ui.questions.active.length)
						ui.questions.active.trigger('mouseout');
						
					if($.inArray(event.which, [33,34,38,40,39,37]) != -1 && (!ui.questions.active || !ui.questions.active.length))
						ui.questions.active = ui.questions.findTopDisplayedQuestion();
					else if($.inArray(event.which, [33,34,38,40]) != -1)
					{
						var i = (event.which > 35 ? 1 : 10) * (event.which % 5 == 3 ? -1 : 1);
						if(!$('#page-questions li[data-filtertext]:visible').length) 
							i = 0;
						var e = ui.questions.active, e2;
						while(i != 0)
						{
							e2 = i > 0 ? e.next('li') : e.prev('li');
							if(!e2 || !e2.length)
								e2 = ui.questions.getLastOrFirst(i > 0);
							if(e2.attr('data-filtertext') && e2.is(':visible'))
								i += i > 0 ? -1 : 1;
							e = e2;
						}
						if(e && e.length)
							ui.questions.active = e;
					}
					
					else if(event.which == 39) // right arrow
						$('a[data-q]', ui.questions.active).trigger('click');
					else if(event.which == 37)
						$('#popup-answer').popup('close');
						
					if($.inArray(event.which, [33,34,38,40]) != -1 && ui.questions.active && ui.questions.active.length)
					{
						$.mobile.silentScroll(ui.questions.active.position().top);
						ui.questions.active.trigger('mouseover');
					}
				}
			};
			this.exam = {
				active : null,
				getQuestionSelection : function() {
					// 40 Fragen sollen es sein
					var q4cat = [];
					var qnum = 40;
					for(var c in app.questions.category)
						q4cat.push({
							v: qnum * app.questions.category[c].list.length / app.questions.questions.length,
							c: c
						});
					
					var selection = [];
					while(selection.length < qnum)
					{
						q4cat.sort(function(a,b){ return b.v - a.v; });
						// get q out of cat
						var q;
						do
						{
							var num = app.questions.category[q4cat[0].c].list.length;
							var pick = Math.floor( Math.random() * ( num + 1 ) );
							q = app.questions.category[q4cat[0].c].list[pick];
						}
						while(isNaN(q) || selection.indexOf(q) != -1);
						selection.push(q);
						q4cat[0].v -= 1;
					}
					
					return selection;
				},
				create : function(e,data) {
					ui.exam.active = null;
					if($(data.prevPage).attr('id') == 'diag-exam-result')
						return;
					
					$('#page-exam').removeClass('reveal');
					var html = '<div class="onreveal"><form><div class="ui-grid-b">';
					html += '<div class="ui-block-a" style="padding-top:11px">';
						html += 'Zeige Antworten:';
					html += '</div>';
					html += '<div class="ui-block-b">';
						html += '<input data-mini="true" type="checkbox" id="exam-show-correct" />';
						html += '<label for="exam-show-correct" class="correct">richtig</label>';
					html += '</div>';
					html += '<div class="ui-block-c">';
						html += '<input data-mini="true" type="checkbox" id="exam-show-incorrect" checked="checked" />';
						html += '<label for="exam-show-incorrect" class="incorrect">falsch</label>';
					html += '</div></div></form><hr /></div>';
					html += '<a id="q-exam-check" href="#popup-exam-result" data-rel="popup" data-position-to="window" data-role="button">prüfen</a>';
					$('#page-exam .content').html(html).trigger('create');
					
					$('#q-exam-check').on('click', ui.exam.showResult);
					
					var questions = ui.exam.getQuestionSelection();
					for(var i in questions)
					{
						$('#q-exam-check').before(
							'<div id="exam_q_' + i + '" class="question">' 
							+ ui.displayQuestion('exam', false, questions[i], {
								prefixTitle : (parseInt(i)+1) + '/' + questions.length + ': ',
								setPostfix : true
							}) + '<hr /></div>'
						);
						(function(i){
							ui.queue.add(function(){ $('#exam_q_' + i).trigger('create'); });
						}(i));
					}
					
					$('#exam-show-incorrect,#exam-show-correct').on('click', ui.exam.updateQuestionList);
					$(window).off('keydown').on('keydown', ui.exam.keyboard);
					ui.queue.run();
				},
				keyboard : function(event) {
					if($.inArray(event.which, [37,38,39,40,49,50,51,65,66,67]) != -1 && (!ui.exam.active || !ui.exam.active.length))
					{
						ui.exam.active = $('#page-exam .question').first();
						$.mobile.silentScroll(ui.exam.active.position().top);
						ui.exam.active.css({backgroundColor:$.Color(255,255,0,192)}).animate({backgroundColor:'transparent'}, 1500);
						return;
					}
					if($.inArray(event.which, [49,50,51,65,66,67]) != -1)
					{
						var k = event.which % 16 - 1;
						if($('.answers input', ui.exam.active).length > k)
							$('.answers input', ui.exam.active).eq(k).prop("checked", 
								!$('.answers input', ui.exam.active).eq(k).is(':checked')
							).checkboxradio("refresh");
					}
					else if($.inArray(event.which, [37,38,39,40]) != -1)
					{
						var e = event.which >= 39 ? ui.exam.active.next('.question') : ui.exam.active.prev('.question');
						if(e.length)
							ui.exam.active = e;
						ui.exam.active.css({backgroundColor:$.Color(255,255,0,192)}).animate({backgroundColor:'transparent'}, 1500);
						$.mobile.silentScroll(ui.exam.active.position().top);
					}
					else if(event.which == 32 && $('#q-exam-check').is(':visible'))
						$('#q-exam-check').trigger('click');
				},
				check : function() {
					$('#page-exam').addClass('reveal');
					$('#q-exam-check').hide();
					
					var result = {};
					var correct = 0;
					$('#page-exam .question').each(function() {
						var q_correct = 1;
						$(this).find('input').each(function() {
							q_correct &= $(this).is(':checked') == $(this).hasClass('correct');
						});
						$(this).addClass(q_correct ? 'correct' : 'incorrect');
						$(this).find('.text').addClass(q_correct ? 'correct' : 'incorrect');
						result[$(this).find('.answers').attr('data-qid')] = q_correct;
					});
					app.flashcard.setMultipleQuestionResult(result);
					
					return {
						correct : $('#page-exam .question.correct').length,
						insg : $('#page-exam .question').length
					};
				},
				updateQuestionList : function() {
					$('#page-exam .question.correct').toggle(
						$('#exam-show-correct').is(':checked')
					);
					$('#page-exam .question.incorrect').toggle(
						$('#exam-show-incorrect').is(':checked')
					);
				},
				showResult : function() {
					var result = ui.exam.check();
					ui.exam.updateQuestionList();
					
					var res = '<p>Du hast ' + result.correct + ' von ' + result.insg + ' Fragen richtig beantwortet.</p>';
					if(result.correct >= 32)
						res += '<p class="correct">Damit hast du die Prüfung bestanden! Glückwunsch!</p>';
					else
						res += '<p class="incorrect">Damit hast du die Prüfung leider nicht bestanden!</p>';
					res += '<a href="#" id="exam-popup-close" data-rel="back" data-role="button">OK</a>';
					
					app.statistic.setExamResult(result.correct >= 32);
					$('#popup-exam-result .content').html(res).trigger('create');
					
					return true;
				}
			};
			this.statistic = {
				show : function() {
					var s = app.statistic.getStatistic();
					
					var result = {"exam" : s.exam, "training" : s.training};
					for(var i in result)
					{
						var res = result[i];
						var p = $('#popup-statistic .' + i);
						var rate = Math.round(100 * res.correct / res.total);
						rate = isNaN(rate) ? '' : rate.toString(10);
						$('.total', p).text(res.total);
						$('.result-correct', p).text(res.correct);
						$('.result-incorrect', p).text(res.total - res.correct);
						$('.rate', p).text(rate + ' %');
						$('.bar .correct', p).css('width', rate + '%');
					}
					
					ui.statistic.showConfidence();
				},
				showConfidence : function () {
					var c = app.flashcard.progress.confidence.slice();
					c.sort(function(a,b){return b-a;});
					
					// empiric derived compensation for aging
					for(var i = 0; i < c.length; i++)
						c[i] /= 0.83 * Math.pow(0.99, i/10);
					
					var w = c.length;
					var h = 100;
					var oldConf = -1;
					var sumConf = 0;
					var dx = 20;
					var dy = 10;
					var ex = 10;
					var ey = 20;
					var d1 = 2;
					var d2 = 2;
					var e = 10;
					
					var steps = [dx + ',' + (dy+h)];
					for(var i = 0; i < c.length; sumConf+= c[i++])
						if(oldConf != c[i])
						{
							if(i)
								steps.push((dx+i) + ',' + (dy+h*(1-oldConf)));
							steps.push((dx+i) + ',' + (dy+h*(1-c[i])));
							oldConf = c[i];
						}
					steps.push((dx+i) + ',' + (dy+h*(1-oldConf)));
					steps.push((dx+i) + ',' + (dy+h));
					
					var html = '<svg class="confidence" preserveAspectRatio="xMinYMin" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 '+(dx+ex+w)+' '+(dy+ey+h)+'">';
					html += '<rect x="'+dx+'" y="'+dy+'" width="'+w+'" height="'+h+'" style="fill:rgb(255,0,0);" />';
					html += '<polygon points="'+steps.join(' ')+'" style="fill:rgb(0,255,0);stroke:rgb(255,255,0);stroke-width:1" />';
					html += '<polygon points="'+(dx)+','+(dy+h)+' '+(w+dx)+','+(dy+h)+' '+(w+dx)+','+(dy+h-d2)+' '+(w+dx+e)+','+(dy+h)+' '+(w+dx)+','+(dy+h+d1)+' '+(w+dx)+','+(dy+h)+'" style="fill:rgb(0,0,0);stroke:rgb(0,0,0);stroke-width:2" />';
					html += '<polygon points="'+(dx)+','+(dy+h)+' '+(dx)+','+(dy)+' '+(dx+d2)+','+(dy)+' '+(dx)+','+(0)+' '+(dx-d1)+','+(dy)+' '+(dx)+','+(dy)+'" style="fill:rgb(0,0,0);stroke:rgb(0,0,0);stroke-width:2" />';
					html += '<text x="70" y="122" fill="black" style="font-size:10px" transform="rotate(0 0,0)">Fragenkatalog</text>';
					html += '<text x="-90" y="16" fill="black" style="font-size:10px" transform="rotate(-90 0,0)">Korrektheit</text>';
					html += '</svg>'
					
					$('#popup-statistic .box').html(html);
					$('#popup-statistic .percent').text(Math.round(100 * sumConf / c.length) + ' %');
				}
			},
			this.settings = {
				show : function() {
					var options = $("#set-question-set");
					options.children().remove();
					$.each(app.questionSets, function(i) {
					    options.append($("<option />").val(i).text(this.name));
					});
					options.val(app.settings.selectedQuestionSet).selectmenu('refresh');
					$('#set-box-size').val(app.flashcard.settings.boxSize).slider('refresh');
					$('#set-expire-factor').val(100 * app.flashcard.settings.expireFactor).slider('refresh');
					$('#set-randomizeQuestions').val(app.settings.randomizeQuestions ? 'on' : 'off').slider("refresh");
				},
				save : function() {
					app.flashcard.setBoxSize(parseInt($('#set-box-size').val()));
					app.flashcard.setExpireFactor(parseInt($('#set-expire-factor').val()) / 100);
					app.settings.randomizeQuestions = $('#set-randomizeQuestions').val() == 'on';
					qsChanged = $('#set-randomizeQuestions').val() != app.settings.selectedQuestionSet;
					if(qsChanged && confirm('Bei einem Wechsel des Fragenkatalogs wird der Lernfortschritt gelöscht! Fortfahren?'))
					{
						app.settings.selectedQuestionSet = $('#set-question-set').val();
						app.loadQuestionCatalog(true);
					}
					app.settings.save();
					return true;
				},
				reset : function() {
					if(confirm('Sollen Einstellungen und Lernfortschritt wirklich gelöscht werden?'))
					{
						app.resetStorage();
						return true;
					}
					return false;
				}
			}
			this.pdf = {
				questions : [],
				show : function(e) {
					html = '';
					for(var i in app.questions.category) {
						html += '<input type="checkbox" id="pdf-cat-' + i + '" data-cat="' + i + '" checked="checked" />';
						html += '<label for="pdf-cat-' + i + '">' + i + '. ' + app.questions.category[i].name + '</label>';
					}
					$('#pdf-cat-select fieldset').html(html)
					$('#pdf-cat-select').trigger('create');
					$('#pdf-question-num').attr('max', app.questions.questions.length).slider("refresh");
					
					ui.pdf.loadScripts();
				},
				loadScripts : function(e) {
					var loaded = false;
					try { if(jsPDF) loaded = true; } catch(e) {}
					if(loaded)
						return;
					
					$.when(
						$.getScript("js/jspdf.js"),
						$.getScript("js/FileSaver.js/FileSaver.js"),
						$.getScript("js/Blob.js/BlobBuilder.js")
					).done(function(){
						$.when(
							$.getScript("js/jspdf.plugin.standard_fonts_metrics.js"),
							$.getScript("js/jspdf.plugin.split_text_to_size.js"),
							$.getScript("js/jspdf.plugin.total_pages.js")
						).done(function(){
							$('#pdf-select-questions').removeClass('ui-disabled');
						});
					});
				},
				select : function() {
					var cats = [];
					$('#pdf-cat-select input:checked').each(function(){
						cats.push($(this).data('cat'));
					});
					if(!pdf)
						pdf = new THWTheorie_PDF()
					
					var num = $('#pdf-question-num').val();
					if(!num) 
						num = 40;
					
					ui.pdf.questions = pdf.getRandomSelection(num, cats);
					
					$('#pdf-gen-questions,#pdf-gen-answers').removeClass('ui-disabled');
				},
				generate : function(withAnswers) {
					var pdfFile = pdf.printQuestionSheet(ui.pdf.questions, withAnswers);
					pdfFile.save(withAnswers ? 'Lösungen.pdf' : 'Fragen.pdf');
				},
				genQuestions : function() { ui.pdf.generate(false); },
				genAnswers : function() { ui.pdf.generate(true); }
			}
		}
		
		var app;
		var ui;
		var pdf = false;
		try {
			app = new THWTheorie();
			ui = new THWTheorie_UIHelper(app);
		} catch(e) {
			alert(e.message);
//			console.log(e.stack, e.message);
			// @todo display startup errors
		}
		
		$(document).ready(function(){
			try { runningOnPhonegap = document.URL.indexOf( 'http://' ) === -1 && document.URL.indexOf( 'https://' ) === -1; } catch(e) {}
			
			// Lernen
			$("#page-ask,#page-show").on("pagebeforeshow", ui.learn.start);
			$('#q-check').on('click', ui.learn.check);
			$('#q-reveal').on('click', ui.learn.reveal);
			$('#q-continue').on('click', ui.learn.show);
			$('#q-not-known').on('click', ui.learn.markResult);
			$('#q-known').on('click', ui.learn.markResult);
			
			// Nachschlagen
			$('#page-questions').on("pagebeforeshow", ui.questions.printQuestionList);
			$('#page-questions').on("pageshow", ui.questions.afterDisplay);
			
			// Prüfung
			$('#page-exam').on('pagebeforeshow', ui.exam.create);
			$("#popup-exam-result").on( "popupafterclose", function(){ $.mobile.silentScroll(0); } );
			
			// Statistik
			$('#m-popup-statistic').on('click', ui.statistic.show);
			
			// info
			$('#lern-info-mehr').on('click', function(){
				$('#diag-lern-info .detail').toggle();
			});
			
			// Einstellungen
			$('#page-settings').on('pagebeforeshow', ui.settings.show);
			$('#set-save').on('click', ui.settings.save);
			$('#set-reset').on('click', ui.settings.reset);
			
			$("#page-pdf").on("pagebeforeshow", ui.pdf.show);
			$('#pdf-select-questions').on('click', ui.pdf.select);
			$('#pdf-gen-questions').on('click', ui.pdf.genQuestions);
			$('#pdf-gen-answers').on('click', ui.pdf.genAnswers);
			
			// Exit on phonegap
			$('#page-mail-exit').toggle(runningOnPhonegap);
			
			// reload action
			$('#update-reload').on('click', function(){ location.reload(); });
		});
	</script>
	<style>
		.reveal .incorrect { color: red; /* text-decoration: line-through; */}
		.reveal .correct { color: green; /* text-decoration: underline; */}
		.reveal label.incorrect { text-decoration: line-through; }
		.reveal label.correct { text-decoration: underline; }
		.reveal .onreveal { display:inline !important; }
		.onreveal { display:none; }
		#page-ask.ask #q-continue { display:none; }
		#page-ask.reveal #q-check { display:none; }
		#page-show.reveal #q-reveal { display:none; }
		#page-show.ask .good { display:none; }
		#page-exam h4 { margin-bottom:0px; }
		.ui-field-contain .ui-controlgroup-controls { width:99%; }
		.indented { padding-left: 1em; }
		#popup-statistic p { margin-top: 0.5em; margin-bottom: 0.5em; }
		#popup-statistic h4 { margin-top: 0.7em; margin-bottom: 0.7em; }
		#popup-statistic .bar { height: 10px; background:red; width:100%; }
		#popup-statistic .bar .correct { height: 10px; background:green; }
		#popup-statistic .confidence { margin: 0px auto; width: 20em; height: 10em; }
		#popup-statistic .cf { height: 1px; background:red; width:100%; }
		#popup-statistic .box { text-align:center; }
		#popup-statistic .cf div { height: 1px; background:green; }
		label .ui-btn-inner { font-size:1.0em !important; max-height: 999999px; }
		h4 { font-size:1.0em !important; max-height: 999999px; }
		p { max-height: 999999px; }
		#page-settings .field-randomizeQuestions .ui-slider-switch { width:99% }
	</style>
</head>
<body>
	<div id="page-main" data-role="page">
		<div data-role="header">
			<a id="page-mail-exit" href="javascript:navigator.app.exitApp();" data-icon="back" data-mini="true" class="ui-btn-left">Beenden</a>
			<h1>THW Theorie</h1>
			<a href="#page-settings" data-icon="gear" data-mini="true" class="ui-btn-right">Einstellungen</a>
		</div>
		<div data-role="content">
			<a href="#page-ask" data-role="button">Lernen - Lösung eingeben</a>
			<a href="#page-show" data-role="button">Lernen - Lösung bestätigen</a>
			<hr />
			<a class="delayed" href="#page-exam" data-role="button">Prüfung simulieren</a>
			<hr />
			<a href="#page-questions" data-role="button">Nachschlagen</a>
			<a id="m-popup-statistic" href="#popup-statistic" data-rel="popup" data-role="button">Statistik</a>
			<hr />
			<a href="#page-pdf" data-role="button">PDF Ausdrucke generieren</a>
			<hr />
			<a href="#page-impressum" data-role="button">Infos zur App</a>
		</div>
		<div id="popup-statistic" data-role="popup" class="reveal" data-overlay-theme="a">
			<div data-role="header">
				<h1 class="title">Lernstatistik</h1>
			</div>
			<div class="content" data-role="content">
				<div class="training">
					<h4>Lernen</h4>
					<p>
						Du hast beim Lernen insgesamt <span class="total"></span> Fragen beantwortet. <br />
						Davon
					</p>
					<div class="indented">
						<span class="correct"><span class="result-correct"></span> richtig</span> und <br />
						<span class="incorrect"><span class="result-incorrect"></span> falsch</span>.
					</div>
					<p>
						Das entspricht einer Quote von <span class="rate"></span>.
					</p>
					<div class="bar"><div class="correct"></div></div>
				</div>
				<hr />
				<div class="exam">
					<h4>Prüfung</h4>
					<p>
						Du hast <span class="total"></span> Prüfungsbögen beantwortet. <br />
						Davon
					</p>
					<div class="indented">
						<span class="correct"><span class="result-correct"></span> richtig</span> und <br />
						<span class="incorrect"><span class="result-incorrect"></span> falsch</span>.
					</div>
					<p>
						Das entspricht einer Quote von <span class="rate"></span>.
					</p>
					<div class="bar"><div class="correct"></div></div>
				</div>
				<hr />
				<div class="flashcard">
					<h4>Lernfortschritt: <span class="percent"></span></h4>
					<div class="box">
					</div>
				</div>
				<a href="#" data-rel="back" data-role="button">OK</a>
			</div>
		</div>
		<div id="popup-update" data-role="popup" class="reveal" data-overlay-theme="a">
			<div data-role="header">
				<h1 class="title">Update</h1>
			</div>
			<div class="content" data-role="content">
				Eine neue Version der Anwendung ist verfügbar.
				<fieldset class="ui-grid-a">
				  <div class="ui-block-a"><button id="update-reload" type="submit" data-theme="c">Gleich laden</button></div>
				  <div class="ui-block-b"><button type="submit" data-theme="a" data-rel="back">Später</button></div>	   
				</fieldset>
			</div>
		</div>
	</div>
	<div id="page-error" data-role="page" data-overlay-theme="b" data-close-btn="none">
		<div data-role="header">
			<h2>Fehler</h2>
		</div>
		<div data-role="content">
			<p class="message"></p>
			<p class="consequence">Die Nutzung der Seite kann leider nicht fortgesetzt werden</p>
		</div>
	</div>
	<div id="page-ask" class="page-question" data-role="page">
		<div data-role="header">
	 		<a href="#page-main" data-icon="arrow-l">Zurück</a>
			<h1 class="title"></h1>
			<a href="#diag-lern-info" data-icon="info" data-mini="true" class="ui-btn-right">Info</a>
		</div>
		<div class="content" data-role="content">
			<div class="question"></div>
			<a id="q-check" href="#" data-role="button">prüfen</a>
			<a id="q-continue" href="#" data-role="button">weiter</a>
		</div>
	</div>
	<div id="page-show" class="page-question" data-role="page">
		<div data-role="header">
	 		<a href="#page-main" data-icon="arrow-l">Zurück</a>
			<h1 class="title"></h1>
			<a href="#diag-lern-info" data-icon="info" data-mini="true" class="ui-btn-right">Info</a>
		</div>
		<div class="content" data-role="content">
			<div class="question"></div>
			<a id="q-reveal" href="#" data-role="button">Antworten zeigen</a>
			<div class="ui-grid-a good">
				<div class="ui-block-a"><a id="q-not-known" class="incorrect" href="#" data-role="button">nicht gewusst</a></div>
				<div class="ui-block-b"><a id="q-known" class="correct" href="#" data-role="button">gewusst</a></div>     
			</div>
		</div>
	</div>
	<div id="page-questions" data-role="page">
		<div data-role="header">
	 		<a href="#page-main" data-icon="arrow-l">Zurück</a>
			<h1 class="title">Fragenkatalog</h1>
		</div>
		<div class="content" data-role="content">
			<ul data-role="listview" data-filter="true" data-inset="true" data-filter-placeholder="Suchbegriff">
			</ul>
			<div id="popup-answer" data-role="popup" data-overlay-theme="a">
				<div data-role="header">
					<h1 class="title"></h1>
				</div>
				<div class="content reveal" data-role="content">
					<div class="question"></div>
					<a href="#" data-rel="back" data-role="button">OK</a>
				</div>
			</div>
		</div>
	</div>
	<div id="page-exam" data-role="page">
		<div data-role="header">
	 		<a href="#page-main" data-icon="arrow-l">Zurück</a>
			<h1 class="title">Prüfung</h1>
		</div>
		<div class="content" data-role="content">
		</div>
		<div id="popup-exam-result" data-role="popup" class="reveal" data-overlay-theme="a">
			<div data-role="header">
				<h1 class="title">Prüfungsresultat</h1>
			</div>
			<div class="content" data-role="content">
			</div>
		</div>
	</div>
	<div id="diag-lern-info" data-role="page" class="reveal">
		<div data-role="header">
	 		<a href="#"  data-rel="back" data-icon="arrow-l">Zurück</a>
			<h1 class="title">Information zum Lernmodus</h1>
		</div>
		<div class="content" data-role="content">
			<p>Diese App berücksichtigt deinen Lernfortschritt bei jeder Frage um die Abfragereihenfolge festzulegen. Hierdurch werden Fragen, bei denen du oft falsch liegst häufiger wiederholt als Fragen die du immer richtig beantwortest. So "nerven" die einfachen Fragen nicht und du konzentrierst dich auf deine Schwachpunkte.</p>
			<hr />
			<a class="detail" id="lern-info-mehr" data-role="button">mehr Infos</a>
			<div class="detail" style="display:none">
				<p>Das System unterteilt den Fragenkatalog in zwei Bereiche, die Abfrage-Box und die Sammel-Box. Die Abfrage-Box hat eine feste Größe von <span class="info-boxSize"></span> Fragen und wird immer von hinten aufgefüllt. Die Sammel-Box enthält die restlichen Fragen und ist entsprechend deines Lernfortschritts bei jeder Frage sortiert.</p> 
				<p>Abgefragt wird immer die vorderste Karte der Abfrage-Box. Beantwortest du die Frage falsch, kommt sie ans Ende der Box, wird also genau nach <span class="info-boxSize"></span> Fragen wiederholt. Ist die Antwort richtig kommt die Frage in die Sammel-Box, einsortiert je nach deinem Lernfortschritt im Vergleich zu den anderen Fragen. Die fehlende Stelle in der Abfrage-Box wird mit der ersten Frage aus der Sammel-Box, also der wahrscheinlich schwierigsten Frage aus dieser Box, aufgefüllt.</p>
				<p>Je öfter du eine Frage richtig beantwortest, je weiter hinten wird sie einsortiert und damit seltner abgefragt.</p>
				<p>Das Verfahren ist natürlich vom <a href="http://de.wikipedia.org/wiki/Lernkartei">Lernkartei-System</a> inspiriert.</p>
			
				<p>Um abzuschätzen wie sicher du bei einer Frage bist, wird eine Methode namens <a href="http://de.wikipedia.org/wiki/Exponentielle_Gl%C3%A4ttung">exponentielle Glättung</a> verwendet. Das funktioniert folgendermaßen:</p>
				<p>Wenn du eine Frage noch nicht beantwortet hast, nimmt das Programm an, dass du die Antwort nicht weißt, also initial 0% Lernfortschritt hast. Beantwortest du die Frage richtig, wird dein aktueller Lernstand (100% für richtig) anteilig mit dem alten Lernfortschritt zum neuen Lernfortschritt zusammengesetzt.</p>  
				<p>Den Anteil kannst du einstellen, er liegt aktuell bei <span class="info-expire"></span> des alten Lernstands.</p> 
			</div>
			<a href="#" data-rel="back" data-role="button">OK</a>
		</div>
	</div>
	<div id="page-settings" data-role="page">
		<div data-role="header">
	 		<a href="#page-main" data-icon="arrow-l">Zurück</a>
			<h1 class="title">Einstellungen</h1>
		</div>
		<div class="content" data-role="content">
			<h1>Einstellungen</h1>
			<form>
				<h2>Fragenkatalog</h2>
				<div class="ui-grid-a">
					<div class="ui-block-a">
						<label for="set-question-set">Welcher Fragenkatalog?</label>
					</div>
					<div class="ui-block-b">
						<select name="questionSet" id="set-question-set">
							<option value="2006">2006</option>
							<option value="2013">2013</option>
						</select>
					</div>	   
				</div>
				
				<h2>Lernfortschritt</h2>
				<div class="ui-grid-a">
					<div class="ui-block-a">
						<label for="set-box-size">Größe der Abfrage-Box:</label>
					</div>
					<div class="ui-block-b">
						<input type="range" id="set-box-size" data-highlight="true" min="10" max="50" value="" />
					</div>	   
				</div>
				<div class="ui-grid-a">
					<div class="ui-block-a">
						<label for="set-expire-factor">Wichtung alte vs. aktuelle Antwort (in Prozent):</label>
					</div>
					<div class="ui-block-b">
						<input type="range" id="set-expire-factor" data-highlight="true" min="10" max="70" value="" />
					</div>	   
				</div>
				<div class="ui-grid-a">
					<div class="ui-block-a">
						<label for="set-randomizeQuestions">Antwortmöglichkeiten mischen:</label>
					</div>
					<div class="ui-block-b field-randomizeQuestions">
						<select name="randomizeQuestions" id="set-randomizeQuestions" data-role="slider">
							<option value="on">Mischen</option>
							<option value="off">Nicht mischen</option>
						</select>
					</div>	   
				</div>
			</form>
			<a id="set-save" href="#" data-rel="back" data-role="button">speichern</a>
			<hr />
			<br />
			<a id="set-reset" href="#" data-rel="back" data-role="button">Einstellungen und Lernfortschritt zurücksetzen</a>
		</div>
	</div>
	<div id="page-pdf" data-role="page">
		<div data-role="header">
			<a data-rel="back" data-icon="back">Zurück</a>
			<h1>THW Theorie</h1>
		</div>
		<div data-role="content">
			<h4>Kategorien für Abfrage-PDF auswählen</h4>
			<div id="pdf-cat-select" data-role="fieldcontain">
				<fieldset data-role="controlgroup">
				</fieldset>
			</div>
			<div class="ui-grid-a">
				<div class="ui-block-a">
					<label for="pdf-question-num">Anzahl der Fragen:</label>
				</div>
				<div class="ui-block-b">
					<input type="range" id="pdf-question-num" data-highlight="true" min="1" max="" value="40" />
				</div>	   
			</div>
			<a id="pdf-select-questions" class="ui-disabled" data-role="button">Fragenauswahl (neu) erzeugen</a>
			<hr />
			<div class="ui-grid-a">
				<div class="ui-block-a"><a id="pdf-gen-questions" class="ui-disabled" data-role="button">Abfrage-PDF generieren</a></div>
				<div class="ui-block-b"><a id="pdf-gen-answers" class="ui-disabled" data-role="button">Lösungs-PDF generieren</a></div>     
			</div>
		</div>
	</div>
	<div id="page-impressum" data-role="page">
		<div data-role="header">
	 		<a href="#page-main" data-icon="arrow-l">Zurück</a>
			<h1 class="title">Infos zur App</h1>
		</div>
		<div class="content" data-role="content">
			<h1>WebApp</h1>
			<p>
				Diese WebApp auf Basis von JQuery und JQuery Mobile ermöglicht eine effektive Vorbereitung 
				auf die <a href="http://www.thw.de/">THW</a> Theorieprüfung. Der komplette Fragenkatalog wird 
				abgefragt, wobei Fragen die besonders oft falsch beantwortet wurden, häufiger wiederholt werden. 
			</p>
			<p>
				Die Anwendung kann in allen modernen Browsern, ob mobil oder am PC, offline verwendet werden. Am
				Besten ein Lesezeichen auf die Startseite setzen und dieses dann immer aufrufen. Der Lernfortschritt 
				bleibt über mehrere Sitzungen erhalten.
			</p>
			
			<h2>Bedienung</h2>
			<p>
				Neben der offensichtlichen Steuerung der App per Maus und Touch, werden auch Tastatureingaben unterstützt. 
			</p>
			<h3>Lernen - Lösungen eingeben</h3>
			<p>
				In Lernmodus können über die Tasten <b>1</b>, <b>2</b> und <b>3</b>, bzw. <b>a</b>, <b>b</b> und <b>c</b>, die Häkchen bei den Fragen gesetzt werden. Zur Auswertung und nächsten Frage geht es mittels <b>Leertaste</b> oder der Cursor-Taste <b>&rarr;</b>.
			</p>
			<h3>Lernen - Lösungen bestätigen</h3>
			<p>
				In diesem Modus geht es mittels <b>Leertaste</b> zur Lösung und das Resultat kann mittels der Cursor-Taste <b>&larr;</b> oder <b>&rarr;</b> ausgewählt werden.
			</p>
			<h3>Prüfungsmodus</h3>
			<p>
				Über die Cursortasten <b>&uarr;</b> und <b>&darr;</b> kann zwischen den Fragen umgeschaltet werden, und mittels <b>1</b>, <b>2</b> und <b>3</b>, bzw. <b>a</b>, <b>b</b> und <b>c</b> die Antwort eingegeben werden.
			</p>
			
			<h2>Besonderer Dank</h2>
			<p>
				Mein Dank gilt <a href="http://thw-theorie.de/">Kai Blaschke</a> der den Fragenkatalog in einer <a href="https://github.com/rwolke/thw-theorie/blob/master/_helper/dl.php">maschinenlesbaren Form</a> auf seiner Seite <a href="http://thw-theorie.de/">thw-theorie.de</a> integriert und kostenlos zur freien Verfügung gestellt hat.
			</p>
			
			<hr />
			<h1>Juristische Erklärungen</h1>
			<p>
				Diese Seite bzw. Web-Anwendung ist ein privates Projekt. Sie steht in keiner direkten Verbindung zur Bundesanstalt Technisches Hilfswerk.
			</p>
			<h2>Lizenz</h2>
			<p>
				<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/de/"><img alt="Creative Commons Lizenzvertrag" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/de/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">THW Theorie WebApp</span> von <span xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName">Robert Wolke</span> steht unter einer <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/de/">Creative Commons Namensnennung - Nicht-kommerziell - Weitergabe unter gleichen Bedingungen 3.0 Deutschland Lizenz</a>.
			</p>
			<p>
				Auf Grundlage dieser Lizenz kann die WebApp gerne weiterentwickelt und auch selbst gehostet werden. Verbesserungsvorschläge und Pull Requests können gerne über GitHub eingereicht werden. 
			</p>
			
			<h2>Marke THW</h2>
			<p>
				Der Zahnkranz, der im Icon der Seite verwendet wird, ist eine eingetragene Wort-Bildmarke der Bundesanstalt Technisches Hilfswerk. Sie wird hier nur dekorativ zum Verweis auf die Bundesanstalt verwendet. 
			</p>
			
			<h2>Haftungsausschluss</h2>
			<p>
				Diese WebApp dient als Hilfsmittel zur Vorbereitung für die THW-Grundausbildung. Trotz sorgfältiger Prüfung und Tests übernehme ich keine Haftung für die Korrektheit und Vollständigkeit der Fragen, Antwortmöglichkeiten und Angaben zur richtigen Antwort. Die Verwendung erfolgt somit auf eigene Gefahr. 
			</p>
			
			<h2>Impressum</h2>
			<p>
				Diese Seite verfügt über kein Impressum nach deutschem Recht:<br />
				Ein Impressum gemäß § 5 TMG ist nicht erforderlich, da es sich nicht um einen geschäftsmäßigen Dienst, 
				sondern eine private Seite handelt. Ebenso werden keine journalistisch-redaktionelle Inhalte veröffentlich, 
				sodass ein Impressum nach § 55 RstV ebenfalls nicht erforderlich ist.<br />
				Für Fragen und Hinweise bin ich über <a href="mailto:r.wolke+app@thw-rostock.de">r.wolke+app@thw-rostock.de</a> zu erreichen.
			</p>
			<h2>Datenschutz</h2>
			<p>
				Die WebApp wird z.Zt. von GitHub unter <a href="http://rwolke.github.io/thw-theorie/">http://rwolke.github.io/thw-theorie/</a> gehostet. Ein Zugriff auf die Seiten könnte deshalb von GitHub protokolliert und die von Ihnen übermittelten Daten gespeichert werden. Hierauf habe ich (Robert Wolke) als Inhalteanbieter keinen Einfluss und Zugriff. Für Fragen dazu lesen Sie bitte die Datenschutzbestimmungen von GitHub.<br />
				<br />
				Die bei der Nutzung der WebApp anfallenden Daten (z.B. der Lernfortschritt oder die Einstellungen) werden ausschließlich in Ihrem Browser gespeichert und von dieser WebApp nicht nach extern übermittelt.
			</p>
		</div>
	</div>
</body>
</html>